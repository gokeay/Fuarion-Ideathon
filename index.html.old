<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiz EkranÄ±: GÃ¶nderi Etki Raporu</title>
    <!-- Gerekli JavaScript kÃ¼tÃ¼phanelerini ekliyoruz (Chart.js versiyonu sabitlendi) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <!-- Leaflet.js (Harita iÃ§in) kÃ¼tÃ¼phanelerini ekliyoruz -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Tailwind CSS'i ve modern bir fontu ekliyoruz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* SayfanÄ±n temel yazÄ± tipini ve arkaplanÄ±nÄ± ayarlÄ±yoruz */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Tailwind'in bg-slate-100 rengi */
        }
        /* KartlarÄ±n daha yumuÅŸak gÃ¶lgelere sahip olmasÄ±nÄ± saÄŸlÄ±yoruz */
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Leaflet harita ve legend stilleri */
        .leaflet-container {
            background: #f1f5f9;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

<div class="max-w-7xl mx-auto space-y-6">

    <!-- 1. BaÅŸlÄ±k ve GÃ¶nderi AlanÄ± -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <!-- Sol Taraf: Orijinal GÃ¶nderi KartÄ± -->
        <div class="lg:col-span-3 bg-white p-6 rounded-2xl custom-shadow">
            <div class="flex items-center mb-4">
                <img src="bakanlik_pp.png" alt="Profil Resmi" class="w-12 h-12 rounded-full mr-4 object-cover border border-gray-200">
                <div>
                    <p class="font-bold text-lg text-slate-800">Ã‡evre, Åehircilik, Ä°klim DeÄŸ. BakanlÄ±ÄŸÄ± Ã‡ÅÄ°DB</p>
                    <p class="text-sm text-slate-500">@cevsehbak Â· 27 AÄŸu</p>
                </div>
            </div>
            <div class="space-y-4">
                <p class="text-slate-700 leading-relaxed">
                    1.231 adet atÄ±k su arÄ±tma tesisi ile, 2002'de %35 olan atÄ±k su arÄ±tma hizmeti verilen belediye nÃ¼fusu oranÄ±nÄ± 2025'te %91.1'e Ã§Ä±kardÄ±ÄŸÄ±mÄ±zÄ± biliyor musunuzâ“
                </p>
                <img src="bakanlik.png" alt="BakanlÄ±k AtÄ±k Su ArÄ±tma Tesisleri" class="rounded-xl w-full object-cover">
                <div class="flex items-center space-x-6 text-slate-600 pt-2 text-sm">
                    <span class="flex items-center font-medium">
                        <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg>
                        3
                    </span>
                    <span class="flex items-center font-medium">
                       <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M7 9l4-4 4 4M4 14h5v5M7 15l4 4 4-4"></path></svg>
                        10
                    </span>
                     <span class="flex items-center font-medium">
                        <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        71
                    </span>
                    <span class="flex items-center font-medium">
                       <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        785
                    </span>
                </div>
            </div>
        </div>
        <!-- SaÄŸ Taraf: Genel Etki PuanÄ± -->
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl custom-shadow flex flex-col justify-center items-center text-center">
            <p class="text-lg font-semibold text-slate-600 mb-2">Genel Duygu Skoru</p>
            <div class="relative w-40 h-40">
                <svg class="w-full h-full" viewBox="0 0 36 36">
                    <path class="text-slate-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.8"></path>
                    <path class="text-green-500" stroke-dasharray="82, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.8" stroke-linecap="round"></path>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-4xl font-extrabold text-slate-800">82%</span>
                </div>
            </div>
            <p class="text-green-600 font-semibold mt-2">Pozitif</p>
            <p class="text-sm text-slate-500 mt-4 italic max-w-xs">
                "YorumlarÄ±n geneli hÃ¼kÃ¼metin Ã§evre politikalarÄ±na ve yatÄ±rÄ±mlarÄ±na yÃ¶nelik olumlu gÃ¶rÃ¼ÅŸler iÃ§eriyor."
            </p>
        </div>
    </div>

    <!-- 2. Kilit Metrikler -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-5 rounded-2xl custom-shadow text-center">
            <p class="text-4xl font-extrabold text-slate-800">1,254</p>
            <p class="text-sm font-medium text-slate-500 mt-1">Toplam Yorum</p>
        </div>
        <div class="bg-white p-5 rounded-2xl custom-shadow text-center">
            <p class="text-4xl font-extrabold text-slate-800">8,732</p>
            <p class="text-sm font-medium text-slate-500 mt-1">Yorumlara Gelen Toplam BeÄŸeni</p>
        </div>
        <div class="bg-white p-5 rounded-2xl custom-shadow text-center">
            <p class="text-4xl font-extrabold text-green-600">75%</p>
            <p class="text-sm font-medium text-slate-500 mt-1">Pozitif Yorum OranÄ±</p>
        </div>
        <div class="bg-white p-5 rounded-2xl custom-shadow text-center">
            <p class="text-4xl font-extrabold text-red-600">21%</p>
            <p class="text-sm font-medium text-slate-500 mt-1">Negatif Yorum OranÄ±</p>
        </div>
    </div>

    <!-- 3. DetaylÄ± Analiz Grafikleri -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl custom-shadow">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Duygu DaÄŸÄ±lÄ±mÄ±</h3>
            <div class="h-64"><canvas id="sentimentDoughnutChart"></canvas></div>
        </div>
        <div class="lg:col-span-3 bg-white p-6 rounded-2xl custom-shadow">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Yorum AkÄ±ÅŸÄ± (Ä°lk 48 Saat)</h3>
            <div class="h-64"><canvas id="commentTimelineChart"></canvas></div>
        </div>
    </div>

    <!-- YENÄ° BÃ–LÃœM: CoÄŸrafi DaÄŸÄ±lÄ±m HaritasÄ± -->
    <div class="bg-white p-6 rounded-2xl custom-shadow">
        <h3 class="text-lg font-bold text-slate-800 mb-4">TÃ¼rkiye EtkileÅŸim HaritasÄ± (Duygu YoÄŸunluÄŸu)</h3>
        <div id="map" class="h-96 md:h-[500px] w-full rounded-lg z-10"></div>
    </div>


    <!-- 4. Niteliksel Analiz -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-2xl custom-shadow">
            <h3 class="text-lg font-bold text-slate-800 mb-4">En Ã‡ok EtkileÅŸim Alan Yorumlar</h3>
            <div class="space-y-5">
                <!-- Yorum 1 -->
                <div class="flex items-start">
                    <img src="https://i.pravatar.cc/40?u=ayse" class="w-10 h-10 rounded-full mr-3 mt-1" alt="Avatar">
                    <div class="flex-1">
                        <p class="font-semibold text-slate-800">AyÅŸe YÄ±lmaz</p>
                        <p class="text-sm text-slate-600">YapÄ±lan hizmetler iÃ§in teÅŸekkÃ¼r ederiz, Ã¼lkemizin bÃ¶yle yatÄ±rÄ±mlara ihtiyacÄ± var.</p>
                        <div class="flex items-center mt-2 text-sm">
                            <span class="text-slate-500 mr-3">â¤ï¸ 1,892 BeÄŸeni</span>
                            <span class="text-xs font-semibold bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Pozitif</span>
                        </div>
                    </div>
                </div>
                <!-- Yorum 2 -->
                <div class="flex items-start">
                    <img src="https://i.pravatar.cc/40?u=mehmet" class="w-10 h-10 rounded-full mr-3 mt-1" alt="Avatar">
                    <div class="flex-1">
                        <p class="font-semibold text-slate-800">Mehmet Ã–ztÃ¼rk</p>
                        <p class="text-sm text-slate-600">Rakamlar gÃ¼zel ama bizim ilÃ§edeki arÄ±tma tesisi hala bitmedi, umarÄ±m en kÄ±sa zamanda tamamlanÄ±r.</p>
                         <div class="flex items-center mt-2 text-sm">
                            <span class="text-slate-500 mr-3">â¤ï¸ 1,245 BeÄŸeni</span>
                            <span class="text-xs font-semibold bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">NÃ¶tr</span>
                        </div>
                    </div>
                </div>
                 <!-- Yorum 3 -->
                 <div class="flex items-start">
                    <img src="https://i.pravatar.cc/40?u=zeynep" class="w-10 h-10 rounded-full mr-3 mt-1" alt="Avatar">
                    <div class="flex-1">
                        <p class="font-semibold text-slate-800">Zeynep Kaya</p>
                        <p class="text-sm text-slate-600">Ã‡evreye yapÄ±lan her yatÄ±rÄ±m geleceÄŸe yatÄ±rÄ±mdÄ±r. EmeÄŸi geÃ§en herkese teÅŸekkÃ¼rler.</p>
                         <div class="flex items-center mt-2 text-sm">
                            <span class="text-slate-500 mr-3">â¤ï¸ 980 BeÄŸeni</span>
                            <span class="text-xs font-semibold bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Pozitif</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-2xl custom-shadow">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Gemini AI ile Tema Analizi</h3>
            <div class="space-y-3">
                <div class="p-3 bg-slate-50 rounded-lg">
                    <p class="font-semibold text-slate-700">1. Projelere TeÅŸekkÃ¼r ve Takdir</p>
                    <p class="text-sm text-slate-500">YorumlarÄ±n Ã§oÄŸunluÄŸu yapÄ±lan hizmetlerden memnuniyetini dile getiriyor.</p>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg">
                    <p class="font-semibold text-slate-700">2. Yerel Proje Talepleri</p>
                    <p class="text-sm text-slate-500">BazÄ± kullanÄ±cÄ±lar kendi bÃ¶lgelerindeki projelerin durumunu sorguluyor.</p>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg">
                    <p class="font-semibold text-slate-700">3. Ã‡evre Bilinci</p>
                    <p class="text-sm text-slate-500">Ã‡evreye yapÄ±lan yatÄ±rÄ±mlarÄ±n Ã¶nemi sÄ±kÃ§a vurgulanÄ±yor.</p>
                </div>
            </div>
            <div class="mt-6 p-4 bg-slate-50 rounded-lg flex flex-wrap gap-x-4 gap-y-2 items-center justify-center">
                <span class="text-4xl font-bold text-green-600">TeÅŸekkÃ¼rler</span>
                <span class="text-3xl font-bold text-indigo-600">YatÄ±rÄ±m</span>
                <span class="text-2xl font-semibold text-sky-600">Hizmet</span>
                <span class="text-lg text-slate-500">bizim ilÃ§e?</span>
                <span class="text-2xl font-semibold text-green-600">Ã‡evre</span>
                <span class="text-xl font-semibold text-indigo-600">Bravo</span>
                <span class="text-3xl font-bold text-sky-600">Gelecek</span>
                <span class="text-lg text-slate-500">proje</span>
            </div>
        </div>
    </div>

    <!-- 5. Eylem ve Raporlama AlanÄ± -->
    <div class="bg-white p-6 rounded-2xl custom-shadow flex flex-col sm:flex-row gap-4">
        <button class="w-full text-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-200">
            âœ¨ Resmi YanÄ±t TaslaÄŸÄ± OluÅŸtur
        </button>
        <button class="w-full text-center px-6 py-3 bg-slate-200 text-slate-800 font-semibold rounded-lg shadow-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-75 transition duration-200">
            ğŸ“„ Rapor Olarak DÄ±ÅŸa Aktar
        </button>
    </div>
</div>

<script>
    // Grafiklerin global ayarlarÄ±
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.plugins.legend.position = 'bottom';

    // Duygu DaÄŸÄ±lÄ±mÄ± GrafiÄŸi (Doughnut)
    const doughnutCtx = document.getElementById('sentimentDoughnutChart');
    if (doughnutCtx) {
        new Chart(doughnutCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pozitif', 'Negatif', 'NÃ¶tr'],
                datasets: [{
                    label: 'Yorum SayÄ±sÄ±',
                    data: [940, 263, 51], // %75, %21, %4 oranlarÄ±na denk gelen sayÄ±lar
                    backgroundColor: ['#22c55e' /* green-500 */, '#ef4444' /* red-500 */, '#64748b' /* slate-500 */],
                    borderColor: '#ffffff',
                    borderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(0);
                                    label += `${context.parsed} Yorum (${percentage}%)`;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Yorum AkÄ±ÅŸÄ± Zaman Ã‡izgisi GrafiÄŸi (Line)
    const timelineCtx = document.getElementById('commentTimelineChart');
    if (timelineCtx) {
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: ['0h', '2h', '4h', '6h', '8h', '12h', '24h', '36h', '48h'],
                datasets: [{
                    label: 'Pozitif Yorumlar',
                    data: [15, 50, 80, 120, 150, 110, 200, 55, 30],
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#22c55e',
                    pointRadius: 0,
                    pointHoverRadius: 6,
                }, {
                    label: 'Negatif Yorumlar',
                    data: [5, 20, 30, 50, 80, 50, 90, 25, 10],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#ef4444',
                    pointRadius: 0,
                    pointHoverRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e2e8f0' // slate-200
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
            }
        });
    }

    // TÃ¼rkiye EtkileÅŸim HaritasÄ± (Leaflet)
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        console.log("Harita baÅŸlatÄ±lÄ±yor...");
        
        // Harita konteynerinin boyutlarÄ±nÄ± kontrol edelim
        console.log("Harita konteyneri boyutlarÄ±:", mapContainer.offsetWidth, "x", mapContainer.offsetHeight);
        
        const map = L.map('map', {
            dragging: false, // KaydÄ±rmayÄ± devre dÄ±ÅŸÄ± bÄ±rak
            scrollWheelZoom: false, // Fare tekerleÄŸi ile yakÄ±nlaÅŸtÄ±rmayÄ± devre dÄ±ÅŸÄ± bÄ±rak
            doubleClickZoom: false, // Ã‡ift tÄ±klama ile yakÄ±nlaÅŸtÄ±rmayÄ± devre dÄ±ÅŸÄ± bÄ±rak
            touchZoom: false, // Dokunmatik yakÄ±nlaÅŸtÄ±rmayÄ± devre dÄ±ÅŸÄ± bÄ±rak
            zoomControl: false // YakÄ±nlaÅŸtÄ±rma kontrollerini kaldÄ±r
        }).setView([39.0, 35.0], 6);

        map.attributionControl.setPrefix('<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>');
        
        // Harita altlÄ±ÄŸÄ±
        const baseMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);
        
        // Debug - haritanÄ±n doÄŸru yÃ¼klenip yÃ¼klenmediÄŸini kontrol edelim
        console.log("Harita altlÄ±ÄŸÄ± eklendi");
        
        // DÃœZELTME: Veri setindeki il isimleri, GeoJSON'daki TÃ¼rkÃ§e karakter iÃ§ermeyen isimlerle eÅŸleÅŸtirildi.
        const sentimentData = {
            "Adana": 0.55, "Adiyaman": 0.35, "Afyonkarahisar": 0.5, "Agri": 0.2,
            "Amasya": 0.6, "Ankara": 0.85, "Antalya": 0.65, "Artvin": 0.7,
            "Aydin": 0.75, "Balikesir": 0.7, "Bilecik": 0.65, "Bingol": 0.25,
            "Bitlis": 0.22, "Bolu": 0.68, "Burdur": 0.6, "Bursa": 0.72,
            "Canakkale": 0.8, "Cankiri": 0.4, "Corum": 0.45, "Denizli": 0.7,
            "Diyarbakir": 0.32, "Edirne": 0.82, "Elazig": 0.4, "Erzincan": 0.42,
            "Erzurum": 0.45, "Eskisehir": 0.81, "Gaziantep": 0.51, "Giresun": 0.72,
            "Gumushane": 0.5, "Hakkari": 0.1, "Hatay": 0.6, "Isparta": 0.55,
            "Mersin": 0.62, "Istanbul": 0.92, "Izmir": 0.78, "Kars": 0.3,
            "Kastamonu": 0.48, "Kayseri": 0.58, "Kirklareli": 0.77, "Kirsehir": 0.5,
            "Kocaeli": 0.73, "Konya": 0.40, "Kutahya": 0.52, "Malatya": 0.48,
            "Manisa": 0.68, "Kahramanmaras": 0.53, "Mardin": 0.33, "Mugla": 0.79,
            "Mus": 0.28, "Nevsehir": 0.65, "Nigde": 0.45, "Ordu": 0.75,
            "Rize": 0.8, "Sakarya": 0.69, "Samsun": 0.68, "Siirt": 0.25,
            "Sinop": 0.7, "Sivas": 0.4, "Tekirdag": 0.78, "Tokat": 0.5,
            "Trabzon": 0.88, "Tunceli": 0.55, "Sanliurfa": 0.3, "Usak": 0.58,
            "Van": 0.29, "Yozgat": 0.38, "Zonguldak": 0.59, "Aksaray": 0.49,
            "Bayburt": 0.41, "Karaman": 0.52, "Kirikkale": 0.53, "Batman": 0.31,
            "Sirnak": 0.15, "Bartin": 0.66, "Ardahan": 0.33, "Igdir": 0.26,
            "Yalova": 0.76, "Karabuk": 0.61, "Kilis": 0.47, "Osmaniye": 0.54,
            "Duzce": 0.67
        };

        function getColor(d) {
            // Daha canlÄ± ve net renk paleti
            return d > 0.8 ? '#10b981' : // yeÅŸil - pozitif
                   d > 0.7 ? '#34d399' : // aÃ§Ä±k yeÅŸil
                   d > 0.6 ? '#fbbf24' : // amber - orta deÄŸer
                   d > 0.5 ? '#f59e0b' : // turuncu
                   d > 0.4 ? '#f43f5e' : // kÄ±rmÄ±zÄ±
                             '#e11d48';  // koyu kÄ±rmÄ±zÄ± - negatif
        }

        let geojson;

        function style(feature) {
            const provinceName = feature.properties.NAME_1;
            const sentiment = sentimentData[provinceName];
            return {
                fillColor: sentiment !== undefined ? getColor(sentiment) : '#cbd5e1',
                weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.8
            };
        }
        
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({ weight: 3, color: '#4f46e5', dashArray: '', fillOpacity: 0.9 });
            layer.bringToFront();
        }

        function resetHighlight(e) { geojson.resetStyle(e.target); }
        
        function onEachFeature(feature, layer) {
            const provinceName = feature.properties.NAME_1;
            
            // Ã–nce doÄŸrudan il adÄ±yla eÅŸleÅŸmeyi deneyelim
            let sentiment = sentimentData[provinceName];
            
            // EÅŸleÅŸme yoksa normalize edilmiÅŸ ada bakalÄ±m
            if (sentiment === undefined) {
                const normalizedName = normalizeProvinceName(provinceName);
                Object.keys(sentimentData).forEach(key => {
                    if (normalizeProvinceName(key).toLowerCase() === normalizedName.toLowerCase()) {
                        sentiment = sentimentData[key];
                    }
                });
            }
            
            let popupContent = `<strong>${provinceName}</strong><br/>`;
            if (sentiment !== undefined) {
                 popupContent += `Pozitif Yorum OranÄ±: %${(sentiment * 100).toFixed(0)}`;
            } else {
                popupContent += "Bu il iÃ§in analiz verisi bulunmamaktadÄ±r.";
            }
            
            // Popup oluÅŸtur ve mouse event'lerini ekle
            layer.bindPopup(popupContent);
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function(e) {
                    // TÄ±klama olayÄ±nda popup'Ä± aÃ§
                    layer.openPopup();
                }
            });
        }

        // Tamamen yeni, daha basit bir yaklaÅŸÄ±m kullanalÄ±m
        // GeoJSON verisini yÃ¼kleyelim
        fetch('https://raw.githubusercontent.com/uyasarkocal/borders-of-turkey/37d3efb5b0f43572b1ad41c62da8abafd1e76fd2/lvl1-TR.geojson')
            .then(response => {
                console.log("GeoJSON yanÄ±tÄ± alÄ±ndÄ±, durum:", response.status);
                return response.json();
            })
            .then(turkeyData => {
                console.log("GeoJSON baÅŸarÄ±yla parse edildi, Ã¶zelliklerin sayÄ±sÄ±:", turkeyData.features.length);
                
                // DEBUG: Ä°lk il Ã¶zelliÄŸini inceleyelim
                if (turkeyData.features && turkeyData.features.length > 0) {
                    console.log("Ä°lk il Ã¶zellikleri:", JSON.stringify(turkeyData.features[0].properties));
                }
                
                // Ä°L Ä°SÄ°MLERÄ° EÅLEÅTÄ°RME TABLOSU - GeoJSON Ã¶zellik adÄ± -> sentimentData anahtarÄ±
                const provinceMapping = {};
                
                // Ä°lk Ã¶zelliÄŸin yapÄ±sÄ±nÄ± inceleyelim - hata ayÄ±klama
                if (turkeyData.features && turkeyData.features.length > 0) {
                    const firstFeature = turkeyData.features[0];
                    console.log("Ä°lk Ã¶zellik tÃ¼m iÃ§eriÄŸi:", firstFeature);
                    console.log("Ä°lk Ã¶zellik properties iÃ§eriÄŸi:", firstFeature.properties);
                    
                    // Ä°l adÄ± Ã¶zelliÄŸini bulmaya Ã§alÄ±ÅŸalÄ±m
                    const propertyKeys = Object.keys(firstFeature.properties);
                    console.log("Ä°lk Ã¶zelliÄŸin tÃ¼m property anahtarlarÄ±:", propertyKeys);
                }
                
                // Basit normalizasyon fonksiyonu - undefined korumasÄ± ile
                function normalize(name) {
                    if (!name) return '';
                    
                    return String(name).toLowerCase()
                        .replace(/Ä±/g, 'i')
                        .replace(/Ã¶/g, 'o')
                        .replace(/Ã¼/g, 'u')
                        .replace(/ÅŸ/g, 's')
                        .replace(/ÄŸ/g, 'g')
                        .replace(/Ã§/g, 'c')
                        .replace(/Ä°/g, 'i')
                        .replace(/Ã–/g, 'o')
                        .replace(/Ãœ/g, 'u')
                        .replace(/Å/g, 's')
                        .replace(/Ä/g, 'g')
                        .replace(/Ã‡/g, 'c');
                }
                
                // Ä°l adÄ± Ã¶zelliÄŸini bulalÄ±m - farklÄ± muhtemel anahtarlar kontrol ediliyor
                function findProvinceNameFromFeature(feature) {
                    if (!feature || !feature.properties) return null;
                    
                    // Muhtemel Ã¶zellik anahtarlarÄ±
                    const possibleKeys = ['NAME_1', 'name', 'Name', 'NAME', 'province', 'Province', 'il', 'Ä°l'];
                    
                    // Her muhtemel anahtarÄ± kontrol et
                    for (const key of possibleKeys) {
                        if (feature.properties[key]) {
                            return feature.properties[key];
                        }
                    }
                    
                    // HiÃ§bir anahtar bulunamadÄ±ysa, ilk string deÄŸerini dÃ¶ndÃ¼r
                    for (const key in feature.properties) {
                        if (typeof feature.properties[key] === 'string') {
                            return feature.properties[key];
                        }
                    }
                    
                    return null;
                }
                
                // TÃœM illeri dolaÅŸÄ±p, isim eÅŸleÅŸtirmelerini hazÄ±rlayalÄ±m
                turkeyData.features.forEach(feature => {
                    // Il adÄ± Ã¶zelliÄŸini alalÄ±m
                    const geoName = findProvinceNameFromFeature(feature);
                    
                    // Ä°l adÄ± kontrolÃ¼
                    if (!geoName) {
                        console.error("Ä°l adÄ± bulunamadÄ±:", feature);
                        return; // Bu Ã¶zelliÄŸi atla
                    }
                    
                    // EÅŸleÅŸme arama
                    let match = null;
                    
                    try {
                        // 1. DoÄŸrudan eÅŸleÅŸme
                        if (sentimentData[geoName] !== undefined) {
                            match = geoName;
                        } 
                        // 2. Normalize edilmiÅŸ eÅŸleÅŸme
                        else {
                            const normalizedGeoName = normalize(geoName);
                            
                            Object.keys(sentimentData).forEach(key => {
                                const normalizedKey = normalize(key);
                                if (normalizedGeoName === normalizedKey) {
                                    match = key;
                                }
                            });
                        }
                        
                        // Ã–zel durumlar iÃ§in manuel eÅŸleÅŸtirmeler
                        if (!match) {
                            // Afyon ve Afyonkarahisar eÅŸleÅŸtirmesi
                            if (geoName === "Afyon") match = "Afyonkarahisar";
                            // Ä°Ã§el ve Mersin eÅŸleÅŸtirmesi
                            else if (geoName === "Icel" || geoName === "Ä°Ã§el") match = "Mersin";
                            // K. MaraÅŸ ve KahramanmaraÅŸ eÅŸleÅŸtirmesi
                            else if (geoName === "K. Maras" || geoName === "K.Maras") match = "Kahramanmaras";
                        }
                        
                        // EÅŸleÅŸtirmeyi kaydet
                        provinceMapping[geoName] = match;
                        
                        // Debug Ã§Ä±ktÄ±sÄ±
                        console.log(`Ä°l: ${geoName} => EÅŸleÅŸme: ${match || "BulunamadÄ±"}`);
                    } catch (error) {
                        console.error(`Ä°l iÅŸlenirken hata: ${geoName}`, error);
                    }
                });
                
                // DEBUG: KaÃ§ il eÅŸleÅŸmiÅŸ gÃ¶relim
                const matchedCount = Object.values(provinceMapping).filter(Boolean).length;
                console.log(`Toplam ${turkeyData.features.length} ilden ${matchedCount} tanesi eÅŸleÅŸti`);
                
                // Renklendirme iÃ§in il verisi stil fonksiyonu
                function provinceStyle(feature) {
                    try {
                        // Ä°l adÄ±
                        const provinceName = findProvinceNameFromFeature(feature);
                        
                        if (!provinceName) {
                            return {
                                fillColor: '#e2e8f0', // Default gri renk
                                weight: 1,
                                opacity: 0.5,
                                color: '#aaa',
                                dashArray: '2',
                                fillOpacity: 0.5
                            };
                        }
                        
                        // EÅŸleÅŸme bulup, duygu deÄŸerini al
                        const matchedName = provinceMapping[provinceName];
                        const sentimentValue = matchedName ? sentimentData[matchedName] : undefined;
                        
                        // Stil dÃ¶ndÃ¼r - doÄŸrudan border ve fill'i ayarlayalÄ±m
                        return {
                            fillColor: sentimentValue !== undefined ? getColor(sentimentValue) : '#e2e8f0',
                            weight: 1.5,
                            opacity: 1,
                            color: 'white',
                            dashArray: '',
                            fillOpacity: 0.9  // Maksimum gÃ¶rÃ¼nÃ¼rlÃ¼k iÃ§in
                        };
                    } catch (error) {
                        console.error("Stil oluÅŸtururken hata:", error, feature);
                        return {
                            fillColor: '#f9a8d4', // Hata durumunda pembe
                            weight: 1,
                            opacity: 1,
                            color: '#f43f5e',
                            dashArray: '5',
                            fillOpacity: 0.5
                        };
                    }
                }
                
                // Hover olayÄ±nda vurgu stili
                function highlightFeature(e) {
                    const layer = e.target;
                    
                    layer.setStyle({
                        weight: 3,
                        color: '#4338ca', // indigo-700
                        dashArray: '',
                        fillOpacity: 0.9
                    });
                    
                    layer.bringToFront();
                }
                
                // Hover Ã§Ä±kÄ±ÅŸÄ±nda reset stili
                function resetHighlight(e) {
                    geoJsonLayer.resetStyle(e.target);
                }
                
                // Her Ã¶zellik iÃ§in popup ve olay dinleyicileri
                function onEachFeature(feature, layer) {
                    try {
                        const provinceName = findProvinceNameFromFeature(feature);
                        
                        if (!provinceName) {
                            layer.bindPopup("<div class='text-red-500 font-bold'>Ä°l adÄ± bulunamadÄ±</div>");
                            return;
                        }
                        
                        const matchedName = provinceMapping[provinceName];
                        const sentiment = matchedName ? sentimentData[matchedName] : undefined;
                        
                        // Popup iÃ§eriÄŸi
                        let popupContent = `<div class="font-bold">${provinceName}</div>`;
                        
                        if (sentiment !== undefined) {
                            // Renk sÄ±nÄ±fÄ± belirle
                            let colorClass = 'text-green-600';
                            if (sentiment < 0.5) colorClass = 'text-red-600';
                            else if (sentiment < 0.7) colorClass = 'text-amber-600';
                            
                            popupContent += `<div class="${colorClass} font-semibold">Pozitif Oran: %${(sentiment * 100).toFixed(0)}</div>`;
                        } else {
                            popupContent += `<div class="text-gray-500 italic">Veri bulunmuyor</div>`;
                        }
                        
                        // Popup'Ä± baÄŸla
                        layer.bindPopup(popupContent);
                        
                        // Olay dinleyicileri
                        layer.on({
                            mouseover: highlightFeature,
                            mouseout: resetHighlight,
                            click: function(e) {
                                // Popup'Ä± gÃ¶ster
                                layer.openPopup();
                                
                                // TÄ±klanan ili vurgula
                                highlightFeature(e);
                            }
                        });
                    } catch (error) {
                        console.error("Popup oluÅŸtururken hata:", error, feature);
                        layer.bindPopup("<div class='text-red-500'>Hata oluÅŸtu</div>");
                    }
                }
                
                // Ana GeoJSON katmanÄ±nÄ± oluÅŸtur ve haritaya ekle
                const geoJsonLayer = L.geoJson(turkeyData, {
                    style: provinceStyle,
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                // Geojson referansÄ±nÄ± gÃ¼ncelle
                geojson = geoJsonLayer;
                
                // Harita sÄ±nÄ±rlarÄ±nÄ± GeoJSON verisine gÃ¶re ayarla
                // Sabit zoom seviyesi ile gÃ¶rÃ¼ntÃ¼leyelim, fitBounds kullanmayalÄ±m
                map.setView([39.0, 35.0], 5.8);
                
                console.log("Harita baÅŸarÄ±yla oluÅŸturuldu!");
            })
            .catch(error => {
                // Hata durumunda kullanÄ±cÄ±ya bilgi verelim
                console.error("GeoJSON yÃ¼klenirken hata oluÅŸtu:", error);
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.innerHTML = `<div class="flex items-center justify-center h-full bg-red-50 text-red-800 p-4 rounded">
                        <div class="text-center">
                            <p class="font-bold">Harita yÃ¼klenirken hata oluÅŸtu</p>
                            <p class="text-sm mt-2">${error.message}</p>
                            <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yeniden Dene</button>
                        </div>
                    </div>`;
                }
            });
        
        // Harita lejantÄ±nÄ± geliÅŸtirerek ekleyelim
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend bg-white p-4 rounded-md custom-shadow');
            
            // Daha okunabilir lejant baÅŸlÄ±ÄŸÄ±
            div.innerHTML = '<div class="text-center mb-2"><strong>Pozitiflik OranÄ±</strong></div>';
            
            // Renk deÄŸer aralÄ±klarÄ±nÄ± ayarla
            const grades = [0.8, 0.7, 0.6, 0.5, 0.4];
            const labels = ['%80+', '%70-80', '%60-70', '%50-60', '%40-50', '<%40'];
            
            // CSS ile renk kutucuklarÄ±nÄ± daha gÃ¼zel gÃ¶ster
            div.innerHTML += '<div class="flex flex-col space-y-2">';
            
            // Her deÄŸer aralÄ±ÄŸÄ± iÃ§in bir satÄ±r oluÅŸtur
            for (let i = 0; i < grades.length; i++) {
                div.innerHTML += 
                    '<div class="flex items-center">' +
                    '<i style="background:' + getColor(grades[i]) + '; width:20px; height:20px; display:inline-block; margin-right:8px; border-radius:2px;"></i> ' +
                    '<span>' + labels[i] + '</span>' +
                    '</div>';
            }
            
            // Son deÄŸer (en dÃ¼ÅŸÃ¼k)
            div.innerHTML += 
                '<div class="flex items-center">' +
                '<i style="background:' + getColor(0.3) + '; width:20px; height:20px; display:inline-block; margin-right:8px; border-radius:2px;"></i> ' +
                '<span>' + labels[5] + '</span>' +
                '</div>';
                
            div.innerHTML += '</div>';
            
            return div;
        };
        legend.addTo(map);
    }
</script>

</body>
</html>

